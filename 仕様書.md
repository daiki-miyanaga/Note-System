# 洋生ノート：入荷数変更＋過去参照 一体型 1ページ仕様 v1.0

## 0. 概要

* 目的：日々の洋生ノートで**入荷数の変更**（実着修正・誤配訂正・遅延反映等）を行う際、**過去実績を同一ページ内で即参照**し、判断を支援する。
* スコープ：単一ページ（SPA相当）で、ヘッダ、サマリー、明細テーブル、**行連動の過去参照ドロワー**、保存／CSV出力／同期（将来Apps Script接続）を提供。
* 前提：オフライン継続（localStorage）、手動同期（Drive/Apps Script）、外部POS/会計連携なし、Androidタブレット/Windows PC対応。

---

## 1. 1ページ構成（情報設計）

```
┌───────────────────────────────────────────┐
│ ヘッダ（対象日・曜日・天気・気温・店舗情報）                    │
├───────────────────────────────────────────┤
│ サマリーカード（入荷合計／販売数量／売上／ロス／完売警告）         │
├───────────────────────────────────────────┤
│ ツールバー（行追加／再計算／保存／CSV出力／同期／前年・前週比較） │
├───────────────────────────────────────────┤
│ 明細テーブル（固定ヘッダ・横スクロール）                           │
│  ├ 行…商品名｜単価｜入荷(編集)｜前日持越し｜予約｜ロス｜終在庫｜… │
│  └ 行の右端：［参照］［履歴］アイコン                               │
├───────────────────────────┬────────────┤
│ 行連動サイドドロワー（右側）                                      ││
│  ● 過去参照（プリセット＋期間選択＋メトリクス＋スパークライン）    ││
│  ● 推奨入荷（ロジック説明／採用ボタン）                            ││
│  ● 変更履歴（誰が・いつ・何を→何に・理由メモ）                     ││
└───────────────────────────┴────────────┘
```

※ ドロワーは行単位で開閉（Esc／外側クリックで閉じる）。

---

## 2. ヘッダ / サマリー

* ヘッダ：`対象日(date)／曜日(自動)／天気(select)／気温(number)／店舗コード(select/自動)`
* サマリーカード（6枚）：

  * アイテム数、入荷合計、販売数量、売上金額、ロス合計、完売警告件数

---

## 3. 明細テーブルの列定義（最小コア＋参照用）

| No | 表示名    | キー           | 入力/計算    | 型  |  必須 | 説明                                             |
| -: | :----- | :----------- | :------- | :- | :-: | :--------------------------------------------- |
|  1 | 商品C    | code         | 入力(既定)   | 文字 |     | 社内コード                                          |
|  2 | 商品名    | name         | 入力(既定)   | 文字 |  ●  | 表示名（検索補助含む）                                    |
|  3 | 単価     | price        | 入力(既定)   | 数値 |  ●  | 税込/税抜は運用定義                                     |
|  4 | 入荷（編集） | arrival      | 入力       | 数値 |  ●  | 実着・訂正可（**本機能の主対象**）                            |
|  5 | 前日持越し  | carryPrev    | 入力(自動提案) | 数値 |     | 前日終在庫の販売可能分                                    |
|  6 | 予約数    | reservation  | 入力       | 数値 |     | 当日引渡分                                          |
|  7 | ロス     | waste        | 入力/計算    | 数値 |     | 当日廃棄確定                                         |
|  8 | 当日終在庫  | endStock     | 入力/計算    | 数値 |     | 閉店棚在庫                                          |
|  9 | 完売時間   | soldoutTime  | 入力       | 時刻 |     | 完売時のみ                                          |
| 10 | 販売数量   | salesActual  | 計算/上書可   | 数値 |     | `max(0, arrival+carryPrev - endStock - waste)` |
| 11 | 売上金額   | revenue      | 計算       | 通貨 |     | `salesActual * price`                          |
| 12 | 参照     | (rowActions) | UI       | -  |     | 行右端の［参照］ボタンでドロワー開く                             |

補足：列は横スクロール。スマホは非対象、タブレット/PC横持ち推奨。

---

## 4. 過去参照ドロワー（行連動UI）

### 4.1 プリセット／期間選択

* プリセット：前日、前週同曜日（−7日×1/×4/×8の中央値）、前年同日、直近7日/30日移動平均、期間指定（開始〜終了）。
* フィルタ：天気種別（晴/雨/雪等）、イベントタグ（セール、催事）、曜日、祝日。

### 4.2 表示メトリクス（該当商品）

* 指標表：`販売数量／入荷／終在庫／ロス／売上金額／完売時間` の日別一覧（最大30行）
* グラフ：販売数量・終在庫・ロスのスパークライン（7日・30日）
* ハイライト：

  * 直近N回の**中央値±MAD×1.5**超過を色付け（異常検知）
  * 完売時間が閉店90分以上前→警告表示（チャンスロス示唆）

### 4.3 推奨入荷（ルールベース初期）

* ベース：同曜日直近8回の**中央値**（過去の外れ値耐性）
* 調整：

  * 天候係数（店別×季節：例 晴1.00/雨0.93/雪0.88）
  * イベント係数（催事＋10〜30%）
  * 在庫目標：閉店時の**目標終在庫q\_target**（0〜2個）
* 提案式：

  * `suggested_arrival = clamp( minMax, round( sales_median * weather_k * event_k + q_target + waste_expected ) )`
  * 端数丸め：5刻み or 個数単位
* UI：推奨値・根拠（採用ボタン／行に反映）。

### 4.4 変更履歴（監査）

* 表示：`時刻／担当／旧→新（arrival）／理由メモ`（直近20件）
* 理由は定型＋自由記述（誤配、遅延、売場判断、返品、品質等）。

---

## 5. 操作フロー（入荷数の変更）

1. 明細行の**入荷**セルを編集、または［参照］でドロワーを開く。
2. ドロワーで過去実績を確認し、必要なら**推奨入荷**を採用。
3. 保存または自動保存（30秒）。
4. 閉店時：終在庫・ロスを確定 → 販売数量と売上が自動更新。
5. CSV出力／同期（オンライン時）。

---

## 6. 計算仕様

* 販売数量：`salesActual = max(0, arrival + carryPrev - endStock - waste)`
* 売上金額：`revenue = salesActual * price`
* 早期完売警告：`soldoutTime`あり かつ `endStock=0` → 警告件数+1
* 推奨入荷：前述4.3の通り（パラメータは店舗別に調整可能）。

---

## 7. データモデル

### 7.1 日別ヘッダ

```json
{
  "date": "2025-09-07",
  "storeId": "KRB01",
  "dayOfWeek": "日",
  "weather": "晴れ",
  "temperature": 28
}
```

### 7.2 明細（1行）

```json
{
  "id": "3201",
  "code": "3201",
  "name": "カスタードプリン",
  "price": 480,
  "arrival": 20,
  "carryPrev": 5,
  "reservation": 3,
  "waste": 0,
  "endStock": 6,
  "soldoutTime": "",
  "salesActual": 19,
  "revenue": 9120
}
```

### 7.3 変更履歴（arrival）

```json
{
  "ts": "2025-09-07T09:32:11+09:00",
  "user": "taro@example.com",
  "rowId": "3201",
  "field": "arrival",
  "old": 18,
  "new": 20,
  "reason": "誤配訂正 +2"
}
```

---

## 8. 保存・過去参照・同期方針

* ローカル：`localStorage` に日付キー `yousei:<YYYY-MM-DD>`、インデックス `yousei:index`。
* 過去参照キャッシュ：ドロワー表示時に必要日のJSONをローカルへ段階的キャッシュ。オフライン時はキャッシュのみ表示。
* 同期（将来）：Apps Script経由でDriveの店別フォルダ（`/洋生ノート/<店舗>/<YYYY>/`）へ日別JSON保存／取得。

---

## 9. バリデーション／例外処理

* 数量は0以上の整数（重量商品は将来拡張）。
* 不整合チェック：`endStock + salesActual + waste ≤ arrival + carryPrev` 未満で警告。
* `soldoutTime`ありかつ`endStock>0`は入力矛盾（確認ダイアログ）。
* 入荷変更時に**理由**の選択を促す（オプション：必須化）。

---

## 10. 権限・監査

* 権限ロール：担当（編集）／店長（編集＋履歴閲覧）／SV（閲覧）。
* 監査ログ：arrival等の重要フィールドは差分ログを常時記録（端末→同期時に集約）。

---

## 11. 非機能要件

* パフォーマンス：100行でも入力応答<100ms、再描画<300ms。
* レイアウト：横1280px以上で快適。タブレット横持ち前提。
* アクセシビリティ：フォーカスリング、読上げラベル、表ヘッダ関連付けを実施。

---

## 12. テスト観点

* 計算整合：販売数量・売上の恒等式、境界値（0、非常大）。
* ドロワー：プリセット切替、オフライン時キャッシュ表示。
* 監査：arrival変更→履歴記帳→CSVには含めない（別エクスポート）。
* 負荷：30日×100行の過去参照でUI劣化がないこと。

---

## 13. ロードマップ

* フェーズ1：本仕様の1ページ版（ローカル保存＋CSV＋過去参照キャッシュ）。
* フェーズ2：Apps Script同期（店別Drive保存、前年/前週API化）。
* フェーズ3：需要予測係数（天候・イベント）の店別自動学習、期限管理の自動ロールオーバー。

---

## 14. オープン質問（要回答）

1. 過去参照の**標準プリセット**の優先順位（前日・前週同曜・前年同日など）を確定したい。
2. 天候係数・イベント係数は**固定値で運用開始**か、店長が編集可能にするか。
3. 変更理由の**必須化**要否（到着遅延・誤配・返品等の選択肢案の確定）。
4. 完売時間の入力粒度（5分刻み／15分刻み）と閉店時刻のマスタ管理方法。
5. CSVの最終列順（社内既存テンプレートに合わせるか）。
6. 端末想定（主力は10〜11inchタブレットか、15inchノートPCか）による列幅初期値。
7. 店舗間移動の表現（本仕様では入荷は実着基準。移動は別列で扱うか、到着した時点でarrivalに取り込むか）。

---

# v1.1 決定事項（ユーザー回答の反映）

* 売上個数：方式Aを採用。`売上個数 = max(0, 入荷 + 前日持越し + 店間移動(±) − 閉店時在庫 − ロス)`
* 予約：Q1（すべて当日引渡扱い）。計算式には含めず、参照メモとして保持。
* 売上金額：**税抜**で算出・表示（税率はマスタ保有、必要に応じて参考で税込表示も可能）。
* 店間移動：在庫計に\*\*純増減(＋入/−出)\*\*で含める。
* 予算（売上見込み）：**本日分は不要**。D+1/D+2は**手動入力**（自動予測は行わない）。
* 消費期限：**例外あり**。商品マスタに販売可能日数を保持（既定2日、商品別上書き）。
* 締切：日単位で「出荷日=入荷日、締切=出荷日2日前」。**休日等の前倒しあり**。**例外承認フローは不要**（締切後は編集不可）。
* 過去参照プリセット：①②は**前年同曜日**を既定（同日に切替可）、③**直近同曜日4回の中央値**。天候フィルタは不要。
* 列表示：通常入力は最小列で簡潔に。**修正時**は「前年同曜日・同日・直近同曜日中央値・完売時間」の参照を**行内で最小スペース**表示。
* 完売時間：**10分刻み**。閉店時刻は**店マスタ固定**。
* 単位：**整数**。入荷は**商品ごとの発注単位**（ロット/ケース）に従い入力。
* 変更理由：**不要**（履歴ログは保持しない）。

---

# v1.1 仕様更新（1ページ完結設計）

## 1. 画面構成（修正）

* ヘッダ：対象日／曜日（自動）／天気／気温／店舗コード
* サマリー：アイテム数・入荷合計・売上個数・売上金額(税抜)・ロス合計・完売警告
* ツールバー：行追加／再計算／保存／CSV出力／同期（将来）／**修正モード切替**／過去参照プリセット
* 明細テーブル（通常表示：最小列）

  * `商品名｜単価(税抜)｜入荷(編集)｜前日持越し｜店間移動(±)｜ロス｜閉店時在庫｜完売時間(10分刻み)｜売上個数(自動)｜売上金額(税抜,自動)`
* **修正モード（行内参照パネル）**

  * 対象行の直下に**折りたたみ行**を展開（1行または2行）
  * 左から順にミニカードを3枚表示：

    * 前年**同曜日**：`販売個数／終在庫／ロス／完売時刻`
    * **同日**（切替）：`販売個数／終在庫／ロス／完売時刻`
    * **直近同曜日4回中央値**：`販売個数／終在庫`
  * 各ミニカードは\*\*数値のみ（大きめフォント）\*\*で、行高を圧迫しないチップ表示
  * 右端に\*\*D+1/D+2 予算(手動)\*\*入力フィールド（個数）を縦並びで配置（小型）

> 目的：サイドドロワーを使わず、1ページ内で最小スペースの**行内参照**を実現。

## 2. 計算仕様（確定）

* 売上個数：`salesQty = max(0, arrival + carryPrev + movement - endStock - waste)`
* 売上金額（税抜）：`revenueEx = salesQty * priceEx`（priceEx＝税抜単価）
* 完売警告：`endStock=0` かつ `soldoutTime` 入力あり → カウント
* 予約：当日引渡メモ。計算・在庫式には含めない。

## 3. 3日帯予算 UI（修正モード）

* 行内参照パネル右側に\*\*D+1/D+2 予算（個数）\*\*の手入力欄（数値）
* 参照のみ：

  * D+1の持越想定＝`max(0, arrival(D+1) + 持越(D0) − 売上予算(D+1) − ロス予算(D+1))`
  * D+2の販売可能在庫の概算（期限ロジックで販売可能日数を超える分は**注意表示**）
* D0（本日）の売上見込みは**不要**（表示しない）

## 4. 締切ロジック（確定）

* `shippingDate = arrivalDate`
* `deadlineBase = shippingDate − 2暦日`
* 休日前倒し：`effectiveDeadline = 直近の営業日前日`（休日マスタに基づく）
* 日単位判定（JST）。**effectiveDeadlineの当日0:00以降は編集不可**（例外承認なし）

## 5. マスタ仕様（抜粋）

* 商品マスタ：

  * `code, name, priceEx, taxRate, orderUnit(最小発注単位), shelfLifeDays(販売可能日数, 既定2)`
* 店舗マスタ：

  * `storeId, name, closingTime(閉店時刻, 10分刻み), holidayCalendarId`

## 6. バリデーション

* 数量：整数 >= 0
* 入荷：`orderUnit`の倍数であること（違反時は赤表示＋丸め候補を提示）
* 完売時間：10分刻み（00,10,20,30,40,50）
* 恒等式チェック：`endStock + salesQty + waste ≤ arrival + carryPrev + movement`

## 7. CSVレイアウト（更新）

`商品C,商品名,単価(税抜),入荷,前日持越し,店間移動(±),ロス,閉店時在庫,完売時間,売上個数,売上金額(税抜),予約数,備考,D+1予算(個),D+2予算(個)`

## 8. 過去参照データの取得ルール

* 既定は**前年同曜日**を自動呼び出し
* 切替：同日／直近同曜日4回中央値（ボタン／タブ）
* 参照値は**数値+時刻**のみを簡潔表示（表は表示しない）

---

# 追加で確認したい最小事項

1. **休日マスタの出所**：全社共通のカレンダー（Googleカレンダー）を参照しますか。CSVでの年次取込にしますか。
2. **発注単位(orderUnit)**：品目ごとに「ケース入数」等で管理してよいですか。例：6、12、24など。
3. **D+1/D+2 予算**：入力は「個数」のみでよいですか。金額予算（税抜）は不要で問題ありませんか。
4. **商品別の販売可能日数**：既定2日からの例外は、1〜3日程度の整数で運用想定でよいですか。

この内容で問題なければ、v1.1を確定版として整えて、次に「画面遷移なしの行内参照UI」のワイヤーフレーム図を追補します。

---

# v1.2 仕様更新（ユーザー追補対応）

## A. マスタ管理の確定

* 休日は**共通マスタ**で管理（名称：`HolidayMaster`）。

  * フィールド例：`date, name, isBusinessDay(boolean)`
  * 締切計算は `isBusinessDay` に基づき**前倒し**を行う。
* 発注単位は\*\*ケース入数（整数）\*\*で商品マスタ `orderUnit` に保持。
* 商品の販売可能日数は**1〜3日の整数**で `shelfLifeDays`。既定は2、商品別に上書き可。

## B. 3日帯（D+1/D+2）予算の金額追加

* 予算は**個数＋金額（税抜）**を扱う。金額は「税抜単価×個数」で**自動算出・表示のみ**（編集不可）。
* 行内参照パネル（修正モード）に以下を追加：

  * `D+1 予算（個）`［入力］ ／ `D+1 予算金額（税抜）`［自動］
  * `D+2 予算（個）`［入力］ ／ `D+2 予算金額（税抜）`［自動］
* サマリーカードを拡張：

  * `D+1 予算合計：個数／金額（税抜）`
  * `D+2 予算合計：個数／金額（税抜）`
* CSVヘッダ（最終版）：

  * `商品C,商品名,単価(税抜),入荷,前日持越し,店間移動(±),ロス,閉店時在庫,完売時間,売上個数,売上金額(税抜),予約数,備考,D+1予算(個),D+1予算金額(税抜),D+2予算(個),D+2予算金額(税抜)`
* CSV先頭メタ（任意）：

  * `# D+1予算 合計：<個数>個 / ¥<金額(税抜)>`
  * `# D+2予算 合計：<個数>個 / ¥<金額(税抜)>`

## C. 計算・バリデーションの補足

* 予算金額（税抜）：`budgetAmountEx = priceEx * budgetQty`（四捨五入不要、整数×整数）。
* 入荷の入力検証：`arrival % orderUnit == 0` を必須。違反時はエラー表示と**最寄りの倍数候補**を提示。
* 完売時間粒度：10分刻みを再確認（00/10/20/30/40/50）。

## D. 画面の差分

* ツールバーに\*\*「修正モード」\*\*トグルを維持。修正モード中は行内参照パネルを展開し、右端に `D+1/D+2 予算（個／金額）` を表示。
* サマリー上部に `D+1/D+2 予算 合計（個／税抜金額）` の2カードを追加。

## E. 参照プリセット（再掲：確定）

* ①②は**前年同曜日**を既定。**同日**へ切替できるタブを提供。
* ③は**直近同曜日4回中央値**。
* 天候フィルタは**非搭載**。

---

（注）本v1.2の内容は v1.1 を上書きする追補です。CSVやUIの金額表示は**税抜**で統一しています。
