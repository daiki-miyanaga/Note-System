# Google Apps Script (GAS) セットアップガイド

洋生ノートシステムにGoogle Apps Scriptを使用したクラウドデータ同期機能を追加するためのセットアップガイドです。

## 📋 概要

このGAS機能により以下が可能になります：
- **Google Cloud Console不要**: GASのウェブアプリ機能のみを使用
- **認証なし**: 「すべてのユーザー」アクセスで簡単設定
- **自動同期**: ローカルデータを定期的にクラウドに同期
- **複数ストレージ**: LocalStorage、Google Drive、GASを並行利用
- **バックアップ機能**: スプレッドシートによる自動バックアップ

## 🚀 セットアップ手順

### 1. Google Apps Script プロジェクト作成

1. [Google Apps Script](https://script.google.com) にアクセス
2. Googleアカウントでログイン
3. 「新しいプロジェクト」をクリック
4. プロジェクト名を「洋生ノート データ同期」に変更

### 2. GAS コード配置

1. デフォルトの `Code.gs` ファイルを選択
2. 既存コードをすべて削除
3. `gas-webapp.gs` ファイルの内容をコピー＆ペースト
4. **Ctrl+S** で保存

### 3. ウェブアプリとしてデプロイ

1. 右上の「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択
3. 設定項目：
   - **種類**: 「ウェブアプリ」を選択
   - **説明**: 「洋生ノート データ同期 API」（任意）
   - **次のユーザーとして実行**: 「自分」を選択
   - **アクセスできるユーザー**: 「すべてのユーザー」を選択 ⚠️重要
4. 「デプロイ」をクリック
5. **ウェブアプリURL**をコピーして保存（後で使用）

### 4. 洋生ノートシステムでの設定

1. `yousei-notebook.html` を開く
2. ツールバーの「🔧 GAS設定」ボタンをクリック
3. 設定画面で以下を入力：
   - **GAS ウェブアプリ URL**: 手順3でコピーしたURL
   - **店舗ID**: 使用する店舗識別子（例：KRB01）
   - **自動同期**: チェックを入れる（推奨）
   - **同期間隔**: 5分（推奨）
4. 「接続テスト」をクリックして接続を確認
5. 「保存して有効化」をクリック

### 5. 動作確認

1. 洋生ノートでデータを入力・保存
2. ブラウザの開発者コンソールで以下のログを確認：
   ```
   🔧 GAS連携が有効になりました
   Data saved successfully (複数ストレージに保存)
   ```
3. Google Apps Script のログを確認：
   - GASプロジェクトの「実行数」でリクエスト履歴を確認
   - エラーがないことを確認

## 📊 データ保存先

GASは自動的にGoogleスプレッドシートにデータを保存します：

### スプレッドシート構造
- **シート名**: 店舗ID別（例：KRB01）
- **列構成**:
  - A列: key（データキー）
  - B列: value（JSON データ）
  - C列: timestamp（作成日時）
  - D列: lastModified（更新日時）

### アクセス方法
1. GAS プロジェクトの「実行」→「実行ログ」で作成されたスプレッドシートIDを確認
2. `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit` でアクセス

## ⚙️ 高度な設定

### カスタム設定（オプション）

#### 固定スプレッドシートID指定
`gas-webapp.gs` の上部で指定可能：
```javascript
const SPREADSHEET_ID = '1ABC...XYZ'; // 既存スプレッドシートのIDを指定
```

#### 同期間隔の変更
洋生ノートの設定画面で以下から選択可能：
- 1分（頻繁な更新）
- 5分（推奨）
- 10分（標準）
- 30分（軽量）
- 1時間（最小限）

### トラブルシューティング

#### 接続エラーが発生する場合
1. **ウェブアプリURL**の確認：
   - `https://script.google.com/macros/s/...../exec` 形式
   - URLの最後に `/exec` があることを確認

2. **デプロイ設定**の確認：
   - 「アクセスできるユーザー」が「すべてのユーザー」になっているか
   - 「次のユーザーとして実行」が「自分」になっているか

3. **新しいデプロイ**で再試行：
   - GASプロジェクトで「デプロイ」→「デプロイを管理」
   - 既存デプロイの「✏️」をクリック
   - 「新しいバージョン」を選択してデプロイ

#### データが同期されない場合
1. ブラウザの**開発者コンソール**でエラーログを確認
2. GAS プロジェクトの**実行ログ**でサーバーサイドエラーを確認
3. 手動同期をテスト：
   - 洋生ノートの「🔧 GAS設定」→「手動同期」

#### 権限エラーの場合
1. Google アカウントでGASプロジェクトにアクセス
2. 必要に応じてスプレッドシート作成権限を確認
3. 異なるGoogleアカウントでテスト

## 🔒 セキュリティ考慮事項

### データの取り扱い
- **アクセス制御**: 「すべてのユーザー」設定により誰でもAPIにアクセス可能
- **データ暗号化**: HTTPSによる通信暗号化
- **認証**: 現在は認証なし（シンプル運用のため）

### セキュリティ強化オプション
将来的に必要に応じて以下の実装が可能：
- APIキーによる認証
- 特定ドメインからのアクセス制限
- リクエスト頻度制限

## 📈 運用とメンテナンス

### 定期メンテナンス
1. **月次**: スプレッドシートのデータサイズ確認
2. **必要時**: 古いデータのアーカイブ
3. **更新時**: GASコードのバージョンアップ

### バックアップ
- GASは自動的にスプレッドシートにバックアップ作成
- 手動バックアップ: GAS設定画面の「手動同期」で即座にバックアップ

### モニタリング
- GAS プロジェクトの「実行数」でAPI使用状況を監視
- エラー率が高い場合は設定やコードを確認

## ❓ FAQ

### Q: Google Cloud Console は必要ですか？
A: **不要**です。Google Apps Script のウェブアプリ機能のみを使用します。

### Q: 認証情報の設定は必要ですか？
A: **不要**です。「すべてのユーザー」アクセスで認証なしでの使用が可能です。

### Q: 複数の店舗で使用できますか？
A: **可能**です。店舗ID別にデータを分離して保存します。

### Q: データの保存期間はありますか？
A: **無制限**です。Google スプレッドシートの容量制限内で保存されます。

### Q: オフライン時はどうなりますか？
A: LocalStorageに保存され、オンライン復帰時に自動同期されます。

## 📞 サポート

技術的な問題やご質問がございましたら、システム管理者までお問い合わせください。

---

**🎯 このセットアップにより、Google Cloud Console不要でシンプルかつ強力なクラウド同期機能が利用できます。**