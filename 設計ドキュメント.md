# 設計ドキュメント（Final）

*Claude codeによるドラフトをCodexCLIがレビューし、技術的補足と品質保証の観点を追記しました。*

## 1. 画面設計 (UI/UX)
本アプリケーションは単一ページアプリケーション（SPA）として設計され、画面遷移なしで全ての操作が完結する。

### 1.1 ワイヤーフレーム構成
（変更なし）

### 1.2 主要画面一覧
（変更なし）

### 1.3 ユーザー操作フロー
（変更なし）

### 1.4 UI/UXに関する技術的補足 (by CodexCLI)
- **入力パフォーマンス:** 「売上個数」などの自動計算処理は、入力のたびに再計算が走るとパフォーマンスが低下する可能性があるため、`debounce`（例: 300ms）を実装し、入力が落ち着いたタイミングで計算処理を実行することが望ましい。
- **アクセシビリティ:** 仕様書記載の通り、テーブルのヘッダ（`<th>`）とセル（`<td>`）の関連付け（`scope`属性）、フォーカス管理、適切なARIA属性の付与を徹底し、スクリーンリーダーでの利用に配慮する。

## 2. アーキテクチャ設計

### 2.1 フロントエンド構成
- **フレームワーク:** React.js または Vue.js
- **状態管理:** Context API (React) や Pinia (Vue) など
- **主要コンポーネント案:** （変更なし）
- **データ永続化:** `localStorage`
- **技術的補足 (by CodexCLI):**
    - **テーブルライブラリ:** 明細テーブルはソート、フィルタリング、行展開などの複雑な状態を持つため、`TanStack Table` などのヘッドレステーブルライブラリの導入を推奨する。これにより、UIロジックとビジネスロジックを分離し、管理を容易にする。
    - **日付処理:** 日付の計算やフォーマットは `date-fns` や `day.js` などの軽量なライブラリを利用し、ブラウザ間の挙動差異を吸収する。

### 2.2 バックエンド構成
- **フェーズ1:** バックエンドなし
- **フェーズ2:** Google Apps Script (GAS) + Google Drive
- **技術的補足 (by CodexCLI):**
    - **GASセキュリティ:** GASで作成するWebアプリは、実行権限を「自分のみ」、アクセスできるユーザーを「Googleアカウントを持つ全員」に設定し、意図しない第三者からのアクセスを防ぐ。APIキーなどの認証情報を導入することも検討する。
    - **エラーハンドリング:** フロントエンドは、`localStorage`への書き込み失敗（容量超過など）や、GAS API呼び出し時のネットワークエラー、サーバエラー（500系）を想定したUI（例: エラートースト通知）を実装する必要がある。

### 2.3 データフロー図（Mermaid記法）
（変更なし）

## 3. データ設計

### 3.1 データベーススキーマ (localStorage)
- **キー:** `yousei:<storeId>:<YYYY-MM-DD>`
    - **CodexCLIによる修正:** 複数店舗のデータを同一ブラウザで扱う可能性を考慮し、店舗IDをキーに含めることでデータ衝突を回避する。
- **値 (日次データオブジェクト):** （変更なし）
- **技術的補足 (by CodexCLI):**
    - **価格データの保持:** 明細データ内に商品単価(`priceEx`)を保持する設計は、過去の取引時点での価格を正確に記録するために適切である。将来、商品マスタの価格が変更されても、過去の売上データに影響を与えない。

### 3.2 マスタデータ
（変更なし）

### 3.3 API仕様（将来拡張: Google Apps Script）
（変更なし）

### 3.4 データ移行・初期化 (by CodexCLI)
- **初回利用時:** アプリケーション初回起動時に、商品マスタや店舗マスタをバックエンド（将来のGAS）から取得、またはフロントエンドにバンドルされたJSONファイルから読み込み、`localStorage`に保存する。
- **マスタ更新:** マスタデータは頻繁には変更されない想定だが、更新が必要な場合は、バージョン管理を行い、アプリ起動時に更新を検知して再取得する仕組みを設ける。

## 4. 品質保証 (QA) (by CodexCLI)
仕様書のテスト観点を具体化し、以下のテストシナリオを定義する。

### 4.1 単体テスト (Unit Test)
- **対象:** 計算ロジック、ユーティリティ関数
- **シナリオ例:**
    - `calculateSalesQty(arrival, carryPrev, movement, endStock, waste)` 関数が、正の数、0、負数（移動）を含む様々な入力に対して正しい売上個数を返すこと。
    - `calculateRevenue(salesQty, priceEx)` が正しい売上金額を返すこと。
    - `validateArrival(arrival, orderUnit)` が、入荷数が発注単位の倍数であるかを正しく判定すること。
    - `localStorage`の読み書きを行うサービスが、例外（パースエラー、書き込み失敗）を適切に処理すること。

### 4.2 結合テスト (Integration Test)
- **対象:** 複数コンポーネントをまたがる機能
- **シナリオ例:**
    - 明細テーブルの「入荷」セルに数値を入力すると、同列の「売上個数」「売上金額」およびサマリーカードの合計値が正しく更新されること。
    - 「修正モード」をONにし、行を選択すると、対応する商品IDの過去データ（前年同曜日など）がAPIから取得され、行内参照パネルに表示されること。
    - 「CSV出力」ボタンを押すと、現在表示されているデータに基づき、仕様通りのヘッダと行を持つCSVファイルがダウンロードされること。
    - 締切日を過ぎたデータを表示した場合、入力セルがすべて無効化（disabled）されていること。

### 4.3 E2E (End-to-End) テスト
- **対象:** 代表的なユーザー操作フロー全体
- **シナリオ例:**
    - 「ユーザーがアプリを開き、日付を選択。数品目の入荷数と終在庫を入力し、一部の商品で修正モードを使い過去を参照しながらD+1予算を入力。最後に保存ボタンを押し、リロードしてもデータが保持されていることを確認。その後、CSVをエクスポートし、その内容が入力値と一致することを確認する。」

### 4.4 パフォーマンス・テスト
- **シナリオ:**
    - 100行以上の明細を持つデータでも、文字入力の応答が100ms以内、再計算・再描画が300ms以内に完了すること。
    - 過去参照パネルの開閉がスムーズであること。
