# 設計ドキュメント（Final by CodexCLI）

本ドキュメントは「仕様書.md」に準拠し、「設計ドキュメント_draft_claude.md」をレビュー・整合・補強した最終版です。用語・命名・UI挙動・計算仕様・CSV仕様・保存方式・テスト観点を明確化し、実装の迷いを減らします。

---

## 0. ポリシーと差分要旨（Lint & 修正）
- 表記統一（日本語UI／英語キー）
  - UI表示語: 仕様書準拠（例: 入荷、前日持越し、ロス、終在庫、完売時間、売上数量、売上金額）
  - データキー: 一貫して lowerCamelCase（例: `arrival`, `carryPrev`, `waste`, `endStock`, `soldoutTime`, `salesQty`, `revenueIncl`）
- 税の扱いを明確化
  - UIおよびCSVは「税込」を基本表示（現場運用での分かりやすさを優先）。
  - 内部は `priceEx`（税抜）+ `taxRate` を保持し、表示/集計は `priceIncl = round(priceEx * (1 + taxRate))` を使用。
- 参照UIの位置を仕様に合わせて統一
  - draftの「行内参照パネル」を「右側サイドドロワー（行連動）」へ変更（仕様書4章）。
- 非コア列の扱い
  - 仕様の最小コアに合わせ、v1は店間移動を未採用（将来拡張欄へ移動）。
- 計算ロジックの厳密化・検証方針の追加（単体・結合テスト）。
- CSV仕様（列順・書式・エンコーディング・小数/時刻）を確定。
- 保存仕様（localStorageキー、バージョン、マイグレーション、オートセーブ）を追加。

---

## 1. 画面設計（UI/UX）

### 1.1 1ページ構成（SPA）
```
┌───────────────────────────────────────────┐
│ ヘッダ（対象日・曜日・天気・気温・店舗）                  │
├───────────────────────────────────────────┤
│ サマリー（アイテム数／入荷合計／売上数量／売上金額／ロス／完売警告） │
├───────────────────────────────────────────┤
│ ツールバー（行追加／再計算／保存／CSV出力／同期(将来)／比較プリセット） │
├───────────────────────────┬────────────┤
│ 明細テーブル（編集可能セル）                          ││
│  … 横スクロール、固定ヘッダ                           ││
├───────────────────────────┤            │
│（行を選択）                                           ││
└───────────────────────────┴─┬───────────┘
                              │右側サイドドロワー（行連動）
                              │・過去参照（プリセット／期間）
                              │・推奨入荷（将来）
                              │・変更履歴（当面は行内備考で代替）
                              └────────────────────
```

### 1.2 テーブル列（v1コア）
- 表示名 / キー / 入力種別 / 型 / 備考
- 商品C / `code` / 既定 / 文字列
- 商品名 / `name` / 既定 / 文字列（検索補助）
- 単価（税込）/ `priceIncl` / 既定 / 数値（内部は `priceEx`+`taxRate` 保持）
- 入荷（編集）/ `arrival` / 入力 / 数値（0以上整数）
- 前日持越し / `carryPrev` / 入力(自動提案) / 数値
- 予約 / `reservation` / 入力 / 数値
- ロス / `waste` / 入力/計算 / 数値
- 当日終在庫 / `endStock` / 入力/計算 / 数値
- 完売時間 / `soldoutTime` / 入力 / 時刻（HH:mm）
- 売上数量 / `salesQty` / 計算/上書可 / 数値
- 売上金額（税込）/ `revenueIncl` / 計算 / 通貨

注：スマホ非対象。タブレット/PC横持ち推奨。数値入力は右寄せ、負値はバリデーションで禁止。

### 1.3 サイドドロワー（行連動）
- プリセット：前日、前週同曜日（×1/×4/×8）、前年同日、直近N中央値、雨天/気温補正（将来）
- 期間選択：任意範囲（折れ線/スパークライン）
- 指標：売上数量、終在庫、完売時間、ロス、金額
- 操作：推奨値を入荷に反映（v1は表示のみ。採用ボタンは次版）

### 1.4 キーボード＆操作性
- Tab/Shift+Tabでセル移動、Enterで確定、Escで編集キャンセル、Escまたは外側クリックでドロワー閉。
- 数値セルは上下キーで±1（Ctrlで±10）。
- 大量行でも固定ヘッダと仮想スクロール風の最適化（後述）

### 1.5 アクセシビリティ
- フォーカス可視、ラベル関連付け、`aria-expanded`/`aria-controls` を用いてドロワー開閉状態を通知。
- コントラスト比 4.5:1 目安、エラー説明はテキストで併記。

---

## 2. 振る舞いと計算仕様

### 2.1 計算式
- 売上数量 `salesQty`
  - 基本式: `max(0, arrival + carryPrev - endStock - waste)`
  - 完売時間が設定されていても上式を優先（完売は状況指標）。
- 単価（税込） `priceIncl`
  - `round(priceEx * (1 + taxRate))`（四捨五入、整数円）。
- 売上金額（税込） `revenueIncl`
  - `salesQty * priceIncl`

注：上書き可能な `salesQty` は、手修正を尊重し再計算では上書きしない（「再計算」は空/未修正セルのみ再計算）。

### 2.2 入力制約・バリデーション
- 全数値は0以上、整数（将来小数対応が必要な場合は別途仕様化）
- `endStock + waste <= arrival + carryPrev` を超える場合はエラー表示（不整合）
- `soldoutTime` は `HH:mm`、24h表記。空許容。
- 列の一括クリア/再計算は確認ダイアログを挟む。

### 2.3 自動提案
- 前日持越し `carryPrev` の初期値は、前日データの `endStock` を転記（存在すれば）。
- サマリーの「完売警告」は `soldoutTime` が設定済みの行件数。

---

## 3. データ設計

### 3.1 ストレージモデル（localStorage）
- キー: `wns.v1.day.${storeId}.${date}`（例: `wns.v1.day.KRB01.2025-09-07`）
- 値(JSON):
```json
{
  "meta": {
    "version": 1,
    "date": "2025-09-07",
    "storeId": "KRB01",
    "weather": "sunny",
    "temperature": 28
  },
  "items": [
    {
      "code": "P001",
      "name": "カスタードプリン",
      "priceEx": 444,
      "taxRate": 0.10,
      "arrival": 24,
      "carryPrev": 5,
      "reservation": 3,
      "waste": 0,
      "endStock": 6,
      "soldoutTime": "",
      "salesQty": 23,
      "remarks": "備考"
    }
  ]
}
```

### 3.2 マスタ（初期同梱／将来外出し）
- 商品マスタ `ProductMaster[]`: `{ code, name, priceEx, taxRate, orderUnit, shelfLifeDays }`
- 店舗マスタ `StoreMaster[]`: `{ storeId, name, closingTime }`
- 休日マスタ `HolidayMaster[]`: `{ date, name, isBusinessDay }`

### 3.3 バージョニングとマイグレーション
- `meta.version` で版管理。ロード時に既知版へ移行（キー名変更や型変更）。
- 失敗時は読み取り専用で開き、ユーザーにエクスポート退避を提示。

---

## 4. CSV仕様

### 4.1 目的と互換
- Excel互換を重視し、UTF-8 with BOM、区切りはカンマ、改行は `\r\n`。

### 4.2 列定義と順序
1. `date` (YYYY-MM-DD)
2. `storeId`
3. `code`
4. `name`
5. `priceIncl`（整数円）
6. `arrival`
7. `carryPrev`
8. `reservation`
9. `waste`
10. `endStock`
11. `soldoutTime`（HH:mm）
12. `salesQty`
13. `revenueIncl`

### 4.3 書式
- 数値は桁区切りなし。空は空文字。時間はゼロ埋め（例: `08:05`）。
- フィールド内にカンマ/改行/二重引用符が含まれる場合は RFC4180 に従いダブルクォートで囲み、内部の `"` は `""` としてエスケープ。

---

## 5. 保存・同期

### 5.1 オフライン保存
- localStorage へ保存。保存操作時/一定時間ごとのオートセーブ（3秒デバウンス）。
- 容量警告（5MB目安）。保存失敗時は明示的に通知。

### 5.2 手動エクスポート/インポート
- JSONバックアップのエクスポート/インポートを提供（検証用）。

### 5.3 将来同期（Apps Script）
- エンドポイント設計は draft 準拠：`GET doGet(date, storeId)` / `POST doPost(body)`。
- 衝突は「サーバ最終更新時刻 vs クライアント最終更新時刻」で解決（将来詳細化）。

---

## 6. 実装方針（v1）
- 技術スタック：Vanilla HTML/CSS/JS（依存最小、タブレット最適化）
- 状態管理：1日1店舗の単一ドキュメント（メモリ常駐 + localStorage）
- 再計算：入力変更時に依存フィールドを都度再計算（デバウンス 150ms）
- レンダリング：テーブルは `position: sticky` で見出し固定、100行規模でのパフォーマンス最適化を念頭（仮想スクロールは次版）
- サイドドロワー：右側`position: fixed`/`translateX`でアニメーション、フォーカストラップ、`aria-*` 付与

---

## 7. エラーハンドリングとUX
- 入力エラーは該当セルにエラースタイル + ツールチップ（例: 「在庫とロスが過大です」）
- 保存成功/失敗のトースト通知。操作は冪等（連打安全）。
- 破壊的操作（全再計算・一括クリア）は確認ダイアログ必須。

---

## 8. パフォーマンス目標
- 入力応答 < 100ms、再計算/再描画 < 300ms（100行）
- 初期ロード < 800ms（ローカル、100行）
- サイドドロワー開閉 < 150ms（60fps目標）

---

## 9. テスト方針

### 9.1 単体テスト（ロジック）
- 計算
  - `salesQty = max(0, arrival + carryPrev - endStock - waste)` の境界（0、過大、空）。
  - `priceIncl` 丸め（税率10%での代表ケース）。
  - `revenueIncl = salesQty * priceIncl` 整合。
- バリデーション
  - 負値禁止、`endStock + waste` の過大検出、時刻書式。
- ストレージ
  - 保存/読込、バージョン移行（v0→v1）。

### 9.2 結合テスト（UI操作）
- データロード→数行編集→再計算→保存→リロードで値が保持。
- 行選択→サイドドロワー開閉→プリセット切替が正しく表示更新。
- CSV出力→Excelで開いて列型/値整合が目視確認できる。

### 9.3 パフォーマンステスト
- 100行ダミーデータで入力応答/再描画時間を計測し閾値内であること。

---

## 10. 将来拡張（スコープ外、設計のみ）
- 店間移動（`movementIn`/`movementOut`）と売上式の拡張
- 推奨入荷（ルール/簡易モデル）と採用ボタン
- マルチデバイス同期・差分マージ・監査ログ
- マスタの外部管理（Drive/Apps Script）
- ロール/権限、変更履歴の厳密記録

---

## 11. 参照
- 仕様書.md（v1.0）
- 設計ドキュメント_draft_claude.md（本最終版のベース）

