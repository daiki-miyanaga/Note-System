# 設計ドキュメント（Draft by Claude code）

## 1. 画面設計 (UI/UX)
本アプリケーションは単一ページアプリケーション（SPA）として設計され、画面遷移なしで全ての操作が完結する。

### 1.1 ワイヤーフレーム構成
v1.2仕様に基づき、画面はヘッダ、サマリー、ツールバー、明細テーブルで構成される。修正モード時には、選択した行の直下に行内参照パネルが展開される。

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ ヘッダ： [2025-09-07(日)] [天気:晴れ v] [気温:28 °C] [店舗:KRB01 v]             │
├──────────────────────────────────────────────────────────────────────────────┤
│ サマリー： [アイテム数:50] [入荷合計:1200] [売上個数:980] [売上金額:¥450,000] ... │
│           [D+1予算:300個/¥150,000] [D+2予算:280個/¥140,000]                     │
├──────────────────────────────────────────────────────────────────────────────┤
│ ツールバー： [行追加] [再計算] [保存] [CSV出力] [修正モード: OFF/ON] [参照:前年同曜 v] │
├──────────────────────────────────────────────────────────────────────────────┤
│ 明細テーブル（通常モード）                                                     │
│ |商品名     |単価 |入荷|前日持越|店間移動|ロス|終在庫|完売時間|売上個数|売上金額|
│ |-----------|-----|----|--------|--------|----|------|--------|--------|--------|
│ |カスタード...| 480 | 20 |   5    |    0   |  0 |   6  |        |   19   |  9,120 |
│ |ショートケ...| 600 | 15 |   3    |   -1   |  1 |   2  | 18:30  |   14   |  8,400 |
├──────────────────────────────────────────────────────────────────────────────┤
│ 明細テーブル（修正モード ON：1行目を選択）                                     │
│ |商品名     |単価 |入荷|前日持越|店間移動|ロス|終在庫|完売時間|売上個数|売上金額|
│ |-----------|-----|----|--------|--------|----|------|--------|--------|--------|
│ |カスタード...| 480 |[20]|   5    |    0   |  0 |   6  |        |   19   |  9,120 |
│ └---(行内参照パネル)-----------------------------------------------------------------┘
│   | [前年同曜] 売:22/在:2 | [同日] 売:25/在:0 | [直近4回中央値] 売:23/在:1 | D+1予算(個):[25] 金額:¥12,000 |
│   |                       |                   |                        | D+2予算(個):[22] 金額:¥10,560 |
│ ┌----------------------------------------------------------------------------------┐
│ |ショートケ...| 600 | 15 |   3    |   -1   |  1 |   2  | 18:30  |   14   |  8,400 |
└─┴────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 主要画面一覧
- **メイン画面（単一ページ）**
    - **通常モード:** データ入力と一覧表示に特化した状態。
    - **修正モード:** 「修正モード」トグルをONにすることで移行。テーブルの行を選択すると、行内参照パネルが展開され、過去データ参照とD+1/D+2予算入力が可能になる。

### 1.3 ユーザー操作フロー
1.  ユーザーはヘッダで対象日を選択する。該当日のデータが`localStorage`から読み込まれる。
2.  **データ入力:** 明細テーブルの「入荷」「前日持越し」「店間移動」「ロス」「閉店時在庫」「完売時間」などのセルを直接編集する。
3.  「売上個数」「売上金額」は入力値に基づき自動計算・更新される。
4.  **過去データ参照（修正モード）:**
    a. ツールバーで「修正モード」をONにする。
    b. 入荷数を検討したい商品の行をクリックする。
    c. 行直下に参照パネルが展開され、「前年同曜日」などの過去実績が表示される。
    d. ツールバーのプリセット切替で「同日」などに参照データを切り替えられる。
    e. 参照パネル内の「D+1/D+2 予算(個)」に数値を入力する。予算金額は自動計算される。
5.  **データ保存:** 「保存」ボタンをクリック、または30秒ごとの自動保存で`localStorage`にデータが書き込まれる。
6.  **データ出力:** 「CSV出力」ボタンで、表示されている日のデータを仕様書指定のフォーマットでダウンロードする。

## 2. アーキテクチャ設計

### 2.1 フロントエンド構成
- **フレームワーク:** React.js または Vue.js を使用する。コンポーネントベースのアーキテクチャにより、UI部品の再利用性とメンテナンス性を高める。
- **状態管理:** `useState` / `useReducer` (React) や `ref` / `reactive` (Vue) などの標準的な状態管理機能を用いる。アプリケーション全体の状態（サマリー、D+1/D+2予算合計など）は、Context APIやPiniaなどで一元管理する。
- **主要コンポーネント案:**
    - `Header.tsx`: 日付選択、天候、店舗情報などを管理。
    - `Summary.tsx`: サマリーカード群を表示。
    - `Toolbar.tsx`: 各種操作ボタンとモード切替トグルを管理。
    - `DataTable.tsx`: 明細テーブル全体。行のレンダリング、スクロールを制御。
        - `DataRow.tsx`: テーブルの各行。通常表示と修正モード表示を切り替える。
        - `InlineReferencePanel.tsx`: 行内参照パネル。過去データと予算入力を表示。
    - `App.tsx`: 全コンポーネントを統合し、全体のレイアウトとデータフローを管理。
- **データ永続化:** `localStorage` を使用。ユーザーが日付を変更した際に、`yousei:<YYYY-MM-DD>` のキーで日次データを読み書きする。

### 2.2 バックエンド構成
- **フェーズ1（初期リリース）:** **バックエンドなし。** 全ての処理はブラウザ内で完結する。
- **フェーズ2（将来拡張）:**
    - **APIサーバー:** Google Apps Script (GAS) を使用。
    - **データベース:** Google Drive。店舗別のフォルダに日次データをJSON形式で保存する。
    - **役割:**
        - 過去データの取得（前年同日など）。
        - 日次データの保存・更新。
        - GASのWebアプリとしてデプロイし、フロントエンドから`fetch`で呼び出す。

### 2.3 データフロー図（Mermaid記法）

```mermaid
graph TD
    subgraph Browser (Client-Side)
        A[ユーザー操作: データ入力/モード切替] --> B{UIコンポーネント};
        B --> C{状態管理ストア};
        C -- データ更新 --> B;
        B -- 表示更新 --> D[画面];

        subgraph データ永続化
            C -- 保存/読込 --> E[localStorage];
        end

        F[CSV出力ボタン] --> C;
        C -- データ取得 --> G[CSV生成処理];
        G --> H[ファイルダウンロード];

        subgraph 将来拡張: 同期
            I[同期ボタン] --> C;
            C -- データ取得 --> J[API Client];
            J -- fetch(POST /daily-data) --> K[(Google Apps Script)];
            K -- fetch(GET /daily-data?date=...) --> J;
        end
    end

    subgraph Google Cloud (Server-Side / Phase 2)
        K -- read/write --> L[(Google Drive)];
    end
```

## 3. データ設計

### 3.1 データベーススキーマ (localStorage)
`localStorage`には、日付をキーとするJSONオブジェクトとして日次データを保存する。

- **キー:** `yousei:YYYY-MM-DD`
- **値 (日次データオブジェクト):**
```json
{
  "header": {
    "date": "2025-09-07",
    "storeId": "KRB01",
    "weather": "晴れ",
    "temperature": 28
  },
  "details": [
    {
      "id": "3201",
      "code": "3201",
      "name": "カスタードプリン",
      "priceEx": 444, // 税抜単価
      "orderUnit": 6,
      "shelfLifeDays": 2,
      "arrival": 24,
      "carryPrev": 5,
      "movement": 0,
      "waste": 0,
      "endStock": 6,
      "soldoutTime": "", // "18:30"
      "salesQty": 23,
      "revenueEx": 10212,
      "reservation": 3,
      "remarks": "備考欄",
      "budget_d1": { "qty": 25, "amountEx": 11100 },
      "budget_d2": { "qty": 22, "amountEx": 9768 }
    }
  ]
}
```

### 3.2 マスタデータ
マスタデータは、初期表示時に固定値として読み込むか、別途JSONファイルとして管理する。

- **商品マスタ (`ProductMaster[]`)**
  `{ code, name, priceEx, taxRate, orderUnit, shelfLifeDays }`
- **店舗マスタ (`StoreMaster[]`)**
  `{ storeId, name, closingTime, holidayCalendarId }`
- **休日マスタ (`HolidayMaster[]`)**
  `{ date, name, isBusinessDay }`

### 3.3 API仕様（将来拡張: Google Apps Script）
- **エンドポイントURL:** Google Apps ScriptのWebアプリURL

#### 1. 日次データの取得
- **Function:** `doGet(e)`
- **HTTP Method:** `GET`
- **Query Params:**
    - `date` (string, `YYYY-MM-DD`): 取得したい日付
    - `storeId` (string): 店舗ID
- **Success Response (200 OK):**
```json
// 上記3.1の「値」と同じ構造のJSON
```
- **Error Response (404 Not Found):**
```json
{ "error": "Data not found" }
```

#### 2. 日次データの保存
- **Function:** `doPost(e)`
- **HTTP Method:** `POST`
- **Request Body:**
```json
// 上記3.1の「値」と同じ構造のJSON
```
- **Success Response (200 OK):**
```json
{ "status": "success", "message": "Data saved for 2025-09-07" }
```
- **Error Response (400 Bad Request):**
```json
{ "status": "error", "message": "Invalid data format" }
```
